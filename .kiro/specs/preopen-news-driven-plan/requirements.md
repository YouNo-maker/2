# Requirements Document

## Introduction
本功能旨在在每日股市开盘前，自动汇聚多源新闻、完成解析与实体映射、多维度打分筛选出当日最具投资价值的股票，并实时生成包含入场/止损/止盈/仓位与情景预案的操盘计划，以提升开盘前决策效率与胜率。

## Requirements

### Requirement 1: 新闻获取与调度
**Objective:** 作为量化研究员/交易员，我希望系统在开盘前稳定、准时地完成多源新闻获取与去重，以确保后续分析有充分、可信的输入。

#### Acceptance Criteria
1. WHEN 到达目标市场交易所日历的开盘前 T-60 分钟 THEN 系统 SHALL 并发拉取所有已配置新闻源在最近时间窗口内的增量内容，并在 T-45 分钟前完成首次抓取。
2. IF 任一新闻源出现 5xx、网络超时或速率受限 THEN 系统 SHALL 采用指数退避重试至多 3 次，失败后降级至备用源，并记录 source_id、错误码与重试次数。
3. WHILE 抓取进行中 THE 系统 SHALL 遵守每源速率限制与并发上限，不超过配置的 QPS/并发阈值。
4. WHERE 服务器提供 ETag 或 Last-Modified THE 系统 SHALL 使用条件请求仅拉取变更内容，并维护内容哈希以去重。

### Requirement 2: 解析与规范化
**Objective:** 作为数据平台使用者，我需要所有新闻被统一解析为标准化结构，确保字段完备与质量可控。

1. WHEN 成功获取到原始内容 THEN 系统 SHALL 提取并标准化标题、正文、时间戳、来源、链接、作者（如有），字段完整率≥99%。
2. IF 文本语言非目标市场主要语言 THEN 系统 SHALL 标注语言并保留原文，不做强制翻译。
3. WHEN 多条内容的正文哈希或链接规范化后相同 THEN 系统 SHALL 去重并保留首个可信来源，记录合并关系。
4. WHERE 原文为 HTML/富文本 THE 系统 SHALL 去噪并保留关键引文与外链计数，移除无关脚本样式。

### Requirement 3: 实体映射与情绪/事件标注
**Objective:** 作为策略开发者，我需要文本被准确地映射到具体股票并标注事件类型与情绪强度，以支持后续量化打分。

1. WHEN 文本中出现公司全称/简称/别名/证券代码 THEN 系统 SHALL 将其映射到唯一股票标识（含交易所与代码），并输出 0-1 置信度。
2. IF 存在多候选歧义 THEN 系统 SHALL 返回候选列表与理由，并仅当最高置信度≥0.70 时纳入后续打分，否则标记为“需复核”。
3. WHEN 完成抽取 THEN 系统 SHALL 输出事件类型（如财报、并购、监管、产能等）、情绪分数与方向（多/空/中性），并附证据句索引。
4. WHERE 映射失败或文本无有效证券实体 THE 系统 SHALL 记录样本并进入低优先级复核队列，不影响主流程。

### Requirement 4: 多维打分与 Top-N 选择
**Objective:** 作为研究与交易团队，我希望系统基于相关性、情绪、事件权重、时效与来源可信度等维度，计算综合分并筛选出 Top-N 候选。

1. WHEN 候选股票完成聚合 THEN 系统 SHALL 依据配置权重计算综合分，并在 T-35 分钟前输出 Top-N（默认 N=5）。
2. IF 候选分数相同且行业集中度过高 THEN 系统 SHALL 应用去偏规则以保持行业多样性，并记录去偏前后差异。
3. WHEN 有历史校准参数可用 THEN 系统 SHALL 应用最新权重版本并在输出中标注权重版本号与时间戳。
4. WHERE 无任何候选达到最小置信阈值 THE 系统 SHALL 返回“无推荐”并提供具体原因（如样本量不足、源异常、置信度不足）。

### Requirement 5: 操盘计划生成与校验
**Objective:** 作为交易员，我需要系统为 Top-1 股票生成可执行的日内操盘计划，含入场、止损、止盈、仓位与执行窗口，并能通过联网检索完善关键信息。

1. WHEN 选出 Top-1 股票 THEN 系统 SHALL 生成包含入场价、止损、止盈、仓位上限、执行窗口与触发条件的计划，输出为结构化 JSON 与可读 Markdown。
2. IF 关键行情特征（如波动率、昨收、关键均线）缺失 THEN 系统 SHALL 回退至规则化参数（如 ATR/昨收/支撑阻力）进行估算，并下调置信度。
3. WHEN 计划生成完成 THEN 系统 SHALL 联网检索最近公告/研报摘要/监管动态以补全证据，并据此调整计划置信度。
4. WHERE 计划内部校验失败（如入场/止损/止盈价格冲突） THE 系统 SHALL 阻止发布并输出修复建议。

### Requirement 6: 突发场景与动态调整
**Objective:** 作为风控负责人，我需要系统在交易时段内对突发事件与异常波动进行快速响应与策略调整。

1. WHEN 交易时段内出现监管通告、重大负面舆情或异常波动 THEN 系统 SHALL 在 5 分钟内完成重评并输出替代策略（缩仓/撤单/延迟/对冲）。
2. IF 情绪方向由正转负且强度变化超过设定阈值 THEN 系统 SHALL 将仓位建议至少下调 50% 并通知相关人员。
3. WHILE 交易时段内 THE 系统 SHALL 每 N 分钟轮询关键源并更新状态（N 可配置），并记录每次评估结果。
4. WHERE 某数据源连续 M 次不可用 THE 系统 SHALL 对该源熔断并发出告警（M 可配置）。

### Requirement 7: 观测、日志与 SLA
**Objective:** 作为平台运营者，我需要对任务稳定性、质量与时效进行可观测与告警，确保 SLA 达成。

1. WHEN 每次任务执行完成 THEN 系统 SHALL 记录抓取成功率、去重率、映射置信度分布、处理耗时与失败原因，并生成可视报表或指标。
2. IF 任一关键指标低于阈值（如抓取成功率 < 99%） THEN 系统 SHALL 产生告警并附近 5 次错误样本以便排障。
3. WHERE 代理或网络异常 THE 系统 SHALL 打印代理环境与回退策略，不泄露敏感密钥。
4. WHILE 服务运行 THE 系统 SHALL 以机器可解析格式输出关键事件，供 Agent 稳定解析与控制。

### Requirement 8: 模型与代理约束（DeepSeek）
**Objective:** 作为合规与成本控制方，我需要模型调用受代理、温度与配额约束，并具备失败回退与结果缓存能力。

1. WHEN 触发 LLM 抽取或生成 THEN 系统 SHALL 使用 DeepSeek API Key 并通过 HTTP(S) 全局代理访问，设置温度 0.2-0.4，通过函数调用返回 JSON 结构。
2. IF LLM 请求失败（超时/配额/5xx） THEN 系统 SHALL 重试并在失败时回退到规则化输出，标注降级原因。
3. WHERE 当日累计调用达到配额阈值 THE 系统 SHALL 延迟或限流非关键任务，确保核心路径完成。
4. WHEN 生成结果可被内容哈希索引 THEN 系统 SHALL 缓存以减少成本，并在命中时直接返回缓存结果。 